<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Exception Dates Functionality</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Test Exception Dates Functionality</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Form Elements</h3>
                
                <!-- Start Date -->
                <div class="mb-3">
                    <label for="schedule_start_date">Start Date</label>
                    <input type="date" id="schedule_start_date" value="2025-01-06" class="form-control">
                </div>
                
                <!-- End Date -->
                <div class="mb-3">
                    <label for="schedule_end_date">End Date</label>
                    <input type="date" id="schedule_end_date" value="2025-02-17" class="form-control">
                </div>
                
                <!-- Pattern -->
                <div class="mb-3">
                    <label for="schedule_pattern">Pattern</label>
                    <select id="schedule_pattern" class="form-control">
                        <option value="weekly" selected>Weekly</option>
                    </select>
                </div>
                
                <!-- Class Type -->
                <div class="mb-3">
                    <label for="class_type">Class Type</label>
                    <select id="class_type" class="form-control">
                        <option value="test" selected>Test Class (20 hours)</option>
                    </select>
                </div>
                
                <!-- Selected Days (hidden checkboxes) -->
                <div style="display: none;">
                    <input type="checkbox" class="schedule-day-checkbox" value="Monday" checked>
                    <input type="checkbox" class="schedule-day-checkbox" value="Wednesday" checked>
                </div>
                
                <!-- Exception Dates Container -->
                <div class="mb-4">
                    <h6>Exception Dates</h6>
                    <div id="exception-dates-container"></div>
                    
                    <!-- Template Row -->
                    <div class="row exception-date-row align-items-center d-none" id="exception-date-row-template">
                        <div class="col-md-4 mb-2">
                            <input type="date" name="exception_dates[]" class="form-control">
                        </div>
                        <div class="col-md-4 mb-2">
                            <select name="exception_reasons[]" class="form-control">
                                <option value="">Select reason</option>
                                <option value="Agent Absent">Agent Absent</option>
                                <option value="Client Closed">Client Closed</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-2">
                            <button type="button" class="btn btn-danger btn-sm remove-exception-btn">Remove</button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-sm" id="add-exception-date-btn">+ Add Exception Date</button>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>Test Results</h3>
                <div id="test-results"></div>
                
                <button id="test-exception-dates" class="btn btn-success">Test Exception Dates</button>
                <button id="add-test-exception" class="btn btn-warning">Add Test Exception (23/06/2025)</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock functions needed for testing
        function getClassTypeHours(classType) {
            return 20; // 20 hours for test
        }
        
        function getDayIndex(dayName) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days.indexOf(dayName);
        }
        
        function getSelectedDays() {
            const selectedDays = [];
            $('.schedule-day-checkbox:checked').each(function() {
                selectedDays.push($(this).val());
            });
            return selectedDays;
        }
        
        function getAllTimeData() {
            return {
                mode: 'single',
                startTime: '09:00',
                endTime: '11:00',
                duration: 2
            };
        }
        
        function updateScheduleData() {
            // Mock function
        }
        
        function updateScheduleTables() {
            // Mock function
        }
        
        // Test the exception dates collection logic
        function testExceptionDatesCollection() {
            const resultsDiv = $('#test-results');
            resultsDiv.empty();
            
            // Test 1: Check if exception date rows are found
            const $exceptionRows = $('#exception-dates-container .exception-date-row');
            resultsDiv.append(`<p><strong>Total exception rows found:</strong> ${$exceptionRows.length}</p>`);
            
            // Test 2: Check if non-template rows are found
            const $nonTemplateRows = $('#exception-dates-container .exception-date-row').filter(function() {
                return $(this).attr('id') !== 'exception-date-row-template';
            });
            resultsDiv.append(`<p><strong>Non-template exception rows:</strong> ${$nonTemplateRows.length}</p>`);
            
            // Test 3: Collect exception dates
            const exceptionDates = [];
            $nonTemplateRows.each(function() {
                const $row = $(this);
                const date = $row.find('input[name="exception_dates[]"]').val();
                const reason = $row.find('select[name="exception_reasons[]"]').val();
                
                resultsDiv.append(`<p><strong>Row found:</strong> Date=${date}, Reason=${reason}, Classes=${$row.attr('class')}</p>`);
                
                if (date) {
                    exceptionDates.push({date: date, reason: reason});
                }
            });
            
            resultsDiv.append(`<p><strong>Exception dates collected:</strong> ${JSON.stringify(exceptionDates)}</p>`);
            
            return exceptionDates;
        }
        
        // Initialize exception dates functionality (simplified)
        function initExceptionDates() {
            const $container = $('#exception-dates-container');
            const $template = $('#exception-date-row-template');
            const $addButton = $('#add-exception-date-btn');

            $addButton.on('click', function() {
                const $newRow = $template.clone();
                $newRow.removeClass('d-none').removeAttr('id');
                $container.append($newRow);

                // Initialize remove button
                $newRow.find('.remove-exception-btn').on('click', function() {
                    $newRow.remove();
                    updateScheduleData();
                });

                // Update schedule data when date or reason changes
                $newRow.find('input, select').on('change', function() {
                    updateScheduleData();
                    setTimeout(function() {
                        testExceptionDatesCollection();
                    }, 100);
                });
            });
        }
        
        // Initialize when document is ready
        $(document).ready(function() {
            initExceptionDates();
            
            $('#test-exception-dates').on('click', function() {
                testExceptionDatesCollection();
            });
            
            $('#add-test-exception').on('click', function() {
                // Add a test exception date
                $('#add-exception-date-btn').trigger('click');
                
                setTimeout(function() {
                    const $lastRow = $('#exception-dates-container .exception-date-row').last();
                    $lastRow.find('input[name="exception_dates[]"]').val('2025-06-23');
                    $lastRow.find('select[name="exception_reasons[]"]').val('Agent Absent');
                    $lastRow.find('input[name="exception_dates[]"]').trigger('change');
                }, 100);
            });
        });
    </script>
</body>
</html>
