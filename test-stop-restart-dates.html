<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stop/Restart Date End Date Calculation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Test Stop/Restart Date End Date Calculation</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Test Scenario</h3>
                <ul>
                    <li><strong>Start Date:</strong> 2025-01-06 (Monday)</li>
                    <li><strong>Pattern:</strong> Weekly</li>
                    <li><strong>Selected Days:</strong> Monday, Wednesday</li>
                    <li><strong>Session Duration:</strong> 2 hours</li>
                    <li><strong>Total Hours Needed:</strong> 20 hours (10 sessions)</li>
                    <li><strong>Stop Period:</strong> 2025-01-20 to 2025-02-03 (2 weeks break)</li>
                </ul>
                
                <h4>Expected Behavior:</h4>
                <p>Without stop period: End date would be around 2025-02-17 (5 weeks)</p>
                <p>With stop period: End date should be around 2025-03-03 (7 weeks, accounting for 2-week break)</p>
            </div>
            
            <div class="col-md-6">
                <h3>Test Results</h3>
                <div id="test-results"></div>
                
                <button id="run-test" class="btn btn-primary">Run Test</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Mock the helper functions we need for testing
        function getDayIndex(dayName) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days.indexOf(dayName);
        }

        function getClassTypeHours(classType) {
            // Mock function - return 20 hours for testing
            return 20;
        }

        // The isDateInStopPeriod function from our implementation
        function isDateInStopPeriod(dateStr, stopRestartPeriods) {
            for (const period of stopRestartPeriods) {
                const stopDate = new Date(period.stopDate);
                const restartDate = new Date(period.restartDate);
                const checkDate = new Date(dateStr);
                
                // Check if the date falls between stop date (inclusive) and restart date (exclusive)
                if (checkDate >= stopDate && checkDate < restartDate) {
                    return true;
                }
            }
            return false;
        }

        // Simplified version of the end date calculation logic for testing
        function calculateEndDateWithStopPeriods(startDate, selectedDays, sessionDuration, totalHours, stopRestartPeriods) {
            const sessionsNeeded = Math.ceil(totalHours / sessionDuration);
            const dayIndices = selectedDays.map(day => getDayIndex(day));
            
            let date = new Date(startDate);
            let sessionsScheduled = 0;
            
            // Set start date to the first occurrence of any selected day
            const currentDayIndex = date.getDay();
            if (!dayIndices.includes(currentDayIndex)) {
                // Find the next occurrence of any selected day
                let daysToAdd = 1;
                let nextDate = new Date(date);
                nextDate.setDate(nextDate.getDate() + daysToAdd);

                while (!dayIndices.includes(nextDate.getDay())) {
                    daysToAdd++;
                    nextDate = new Date(date);
                    nextDate.setDate(nextDate.getDate() + daysToAdd);
                }

                date = nextDate;
            }
            
            // Add days until we have enough sessions
            while (sessionsScheduled < sessionsNeeded) {
                const dateStr = date.toISOString().split('T')[0];
                const currentDayIndex = date.getDay();
                
                // Only count days that are in our selected days list and not in stop periods
                if (dayIndices.includes(currentDayIndex) && !isDateInStopPeriod(dateStr, stopRestartPeriods)) {
                    sessionsScheduled++;
                }
                
                // Move to next day
                date.setDate(date.getDate() + 1);
            }
            
            return date.toISOString().split('T')[0];
        }

        function runTest() {
            const resultsDiv = $('#test-results');
            resultsDiv.empty();
            
            // Test parameters
            const startDate = '2025-01-06'; // Monday
            const selectedDays = ['Monday', 'Wednesday'];
            const sessionDuration = 2;
            const totalHours = 20;
            
            // Test without stop periods
            const endDateWithoutStop = calculateEndDateWithStopPeriods(startDate, selectedDays, sessionDuration, totalHours, []);
            
            // Test with stop periods
            const stopRestartPeriods = [{
                stopDate: '2025-01-20',
                restartDate: '2025-02-03'
            }];
            const endDateWithStop = calculateEndDateWithStopPeriods(startDate, selectedDays, sessionDuration, totalHours, stopRestartPeriods);
            
            // Display results
            resultsDiv.append(`
                <div class="test-result test-pass">
                    <strong>Test 1 - Without Stop Period:</strong><br>
                    End Date: ${endDateWithoutStop}<br>
                    Expected: Around 2025-02-17
                </div>
            `);
            
            resultsDiv.append(`
                <div class="test-result test-pass">
                    <strong>Test 2 - With Stop Period:</strong><br>
                    End Date: ${endDateWithStop}<br>
                    Expected: Around 2025-03-03<br>
                    Difference: ${Math.round((new Date(endDateWithStop) - new Date(endDateWithoutStop)) / (1000 * 60 * 60 * 24))} days
                </div>
            `);
            
            // Test the isDateInStopPeriod function specifically
            const testDates = [
                '2025-01-19', // Before stop period
                '2025-01-20', // Start of stop period
                '2025-01-27', // During stop period
                '2025-02-02', // End of stop period (should still be stopped)
                '2025-02-03', // After stop period (should be active)
            ];
            
            resultsDiv.append('<h5>Stop Period Function Tests:</h5>');
            
            testDates.forEach(testDate => {
                const isInStopPeriod = isDateInStopPeriod(testDate, stopRestartPeriods);
                const expected = testDate >= '2025-01-20' && testDate < '2025-02-03';
                const isCorrect = isInStopPeriod === expected;
                
                resultsDiv.append(`
                    <div class="test-result ${isCorrect ? 'test-pass' : 'test-fail'}">
                        Date: ${testDate} - In Stop Period: ${isInStopPeriod} (Expected: ${expected}) ${isCorrect ? '✓' : '✗'}
                    </div>
                `);
            });
        }

        $('#run-test').on('click', runTest);
        
        // Run test automatically on page load
        $(document).ready(function() {
            runTest();
        });
    </script>
</body>
</html>
